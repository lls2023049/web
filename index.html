<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­æ´»åŠ¨æŠ¥åç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header h1 { color: #333; font-size: 24px; }
        header p { color: #666; margin-top: 5px; }
        .nav { display: flex; gap: 10px; margin-top: 15px; }
        .nav button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .nav button.active { background: #667eea; color: white; }
        .nav button:not(.active) { background: #f0f0f0; color: #333; }
        .nav button:hover { transform: translateY(-2px); }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { color: #333; margin-bottom: 10px; }
        .card p { color: #666; font-size: 14px; line-height: 1.6; }
        .card .meta { display: flex; gap: 20px; margin-top: 10px; color: #888; font-size: 13px; }
        .card .meta span { display: flex; align-items: center; gap: 5px; }
        .btn { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .status { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 12px; }
        .status-open { background: #d4edda; color: #155724; }
        .status-full { background: #f8d7da; color: #721c24; }
        .status-registered { background: #cce5ff; color: #004085; }
        .btn-registered { background: #6c757d; color: white; cursor: not-allowed; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; }
        .modal-content h3 { margin-bottom: 20px; }
        .captcha-box { display: flex; gap: 10px; align-items: center; }
        .captcha-box .captcha { background: #f0f0f0; padding: 10px 20px; font-size: 20px; font-weight: bold; letter-spacing: 5px; border-radius: 5px; }
        .captcha-box button { padding: 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-info .avatar { width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .number { font-size: 32px; font-weight: bold; color: #667eea; }
        .stat-card .label { color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ“ æ ¡å›­æ´»åŠ¨æŠ¥åç³»ç»Ÿ</h1>
                    <p>é«˜å¹¶å‘Webç³»ç»Ÿæ¶æ„è®¾è®¡Demo</p>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="avatar" id="userAvatar">å¼ </div>
                    <span id="userName">å¼ ä¸‰</span>
                    <button class="btn" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
            <div class="nav">
                <button class="active" onclick="showSection('events')">æ´»åŠ¨åˆ—è¡¨</button>
                <button onclick="showSection('myRegistrations')">æˆ‘çš„æŠ¥å</button>
                <button onclick="showSection('architecture')">æ¶æ„è¯´æ˜</button>
                <button id="loginBtn" onclick="showModal('loginModal')">ç™»å½•</button>
            </div>
        </header>

        <!-- æ´»åŠ¨åˆ—è¡¨ -->
        <div id="events" class="section active">
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="totalEvents">0</div>
                    <div class="label">æ´»åŠ¨æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="cacheHit">-</div>
                    <div class="label">ç¼“å­˜å‘½ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="responseTime">-</div>
                    <div class="label">å“åº”æ—¶é—´(ms)</div>
                </div>
            </div>
            <div id="eventList"></div>
        </div>

        <!-- æˆ‘çš„æŠ¥å -->
        <div id="myRegistrations" class="section">
            <div class="card">
                <h3>æˆ‘çš„æŠ¥åè®°å½•</h3>
                <div id="registrationList"></div>
            </div>
        </div>

        <!-- æ¶æ„è¯´æ˜ -->
        <div id="architecture" class="section">
            <div class="card">
                <h3>ğŸ—ï¸ ç³»ç»Ÿæ¶æ„</h3>
                <p>æœ¬ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š</p>
                <ul style="margin: 15px 0 15px 20px; color: #666;">
                    <li><strong>APIç½‘å…³</strong>ï¼šç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£è·¯ç”±ã€é™æµã€è®¤è¯</li>
                    <li><strong>ç”¨æˆ·æœåŠ¡</strong>ï¼šå¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç®¡ç†</li>
                    <li><strong>æ´»åŠ¨æœåŠ¡</strong>ï¼šå¤„ç†æ´»åŠ¨åˆ›å»ºã€æŸ¥è¯¢ã€ç®¡ç†</li>
                    <li><strong>æŠ¥åæœåŠ¡</strong>ï¼šå¤„ç†æŠ¥åè¯·æ±‚ã€åé¢ç®¡ç†</li>
                </ul>
            </div>
            <div class="card">
                <h3>âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
                <ul style="margin: 15px 0 15px 20px; color: #666;">
                    <li><strong>Redisç¼“å­˜</strong>ï¼šæ´»åŠ¨ä¿¡æ¯ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›</li>
                    <li><strong>ä»¤ç‰Œæ¡¶é™æµ</strong>ï¼šé˜²æ­¢æµé‡æ¿€å¢å¯¼è‡´ç³»ç»Ÿå´©æºƒ</li>
                    <li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šå¼‚æ­¥å¤„ç†æŠ¥åè¯·æ±‚</li>
                    <li><strong>éªŒè¯ç æœºåˆ¶</strong>ï¼šé˜²æ­¢åˆ·å•æ”»å‡»</li>
                </ul>
            </div>
            <div class="card">
                <h3>ğŸ”’ å®‰å…¨é˜²æŠ¤</h3>
                <ul style="margin: 15px 0 15px 20px; color: #666;">
                    <li><strong>å‚æ•°åŒ–æŸ¥è¯¢</strong>ï¼šé˜²å¾¡SQLæ³¨å…¥æ”»å‡»</li>
                    <li><strong>å¯†ç å“ˆå¸Œ</strong>ï¼šSHA256åŠ å¯†å­˜å‚¨</li>
                    <li><strong>ä¼šè¯ç®¡ç†</strong>ï¼šTokenè®¤è¯æœºåˆ¶</li>
                </ul>
            </div>
            <div class="card">
                <h3>ğŸ“Š ç›‘æ§ä¸æ—¥å¿—</h3>
                <ul style="margin: 15px 0 15px 20px; color: #666;">
                    <li><strong>ELK Stack</strong>ï¼šæ—¥å¿—æ”¶é›†ä¸åˆ†æ</li>
                    <li><strong>Prometheus</strong>ï¼šç³»ç»ŸæŒ‡æ ‡ç›‘æ§</li>
                    <li><strong>Grafana</strong>ï¼šå¯è§†åŒ–ä»ªè¡¨ç›˜</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3>ç”¨æˆ·ç™»å½•</h3>
            <div id="loginAlert"></div>
            <div class="form-group">
                <label>å­¦å·</label>
                <input type="text" id="loginStudentId" placeholder="è¯·è¾“å…¥å­¦å·" value="2021001">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " value="123456">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                <button class="btn" onclick="hideModal('loginModal')">å–æ¶ˆ</button>
            </div>
            <p style="margin-top: 15px; color: #888; font-size: 12px;">
                æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchToRegister()" style="color: #667eea;">ç«‹å³æ³¨å†Œ</a>
            </p>
            <p style="color: #888; font-size: 12px;">æµ‹è¯•è´¦å·ï¼š2021001 / 123456</p>
        </div>
    </div>

    <!-- æ³¨å†Œå¼¹çª— -->
    <div id="registerUserModal" class="modal">
        <div class="modal-content">
            <h3>ç”¨æˆ·æ³¨å†Œ</h3>
            <div id="registerUserAlert"></div>
            <div class="form-group">
                <label>å­¦å·</label>
                <input type="text" id="regStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <div class="form-group">
                <label>å­¦é™¢</label>
                <select id="regCollege" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="1">è®¡ç®—æœºå­¦é™¢</option>
                    <option value="2">å•†å­¦é™¢</option>
                    <option value="3">æ–‡å­¦é™¢</option>
                    <option value="4">ç†å­¦é™¢</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="registerUser()">æ³¨å†Œ</button>
                <button class="btn" onclick="hideModal('registerUserModal')">å–æ¶ˆ</button>
            </div>
            <p style="margin-top: 15px; color: #888; font-size: 12px;">
                å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchToLogin()" style="color: #667eea;">ç«‹å³ç™»å½•</a>
            </p>
        </div>
    </div>

    <!-- æŠ¥åå¼¹çª— -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h3>æ´»åŠ¨æŠ¥å</h3>
            <div id="registerAlert"></div>
            <p id="registerEventTitle" style="margin-bottom: 15px; color: #666;"></p>
            <div class="form-group">
                <label>éªŒè¯ç </label>
                <div class="captcha-box">
                    <input type="text" id="captchaInput" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="flex: 1;">
                    <span class="captcha" id="captchaCode">XXXX</span>
                    <button onclick="refreshCaptcha()">åˆ·æ–°</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="submitRegistration()">ç¡®è®¤æŠ¥å</button>
                <button class="btn" onclick="hideModal('registerModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;
        let currentEventId = null;
        let captchaSession = null;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
            const saved = localStorage.getItem('user');
            if (saved) {
                currentUser = JSON.parse(saved);
                updateUserUI();
            }
        });

        // æ˜¾ç¤º/éšè—åŒºå—
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (id === 'myRegistrations' && currentUser) loadMyRegistrations();
        }

        // æ˜¾ç¤º/éšè—å¼¹çª—
        function showModal(id) { document.getElementById(id).classList.add('show'); }
        function hideModal(id) { document.getElementById(id).classList.remove('show'); }

        // ç”¨æˆ·å·²æŠ¥åçš„æ´»åŠ¨IDåˆ—è¡¨
        let userRegisteredEvents = [];

        // åŠ è½½æ´»åŠ¨åˆ—è¡¨
        async function loadEvents() {
            const start = Date.now();
            try {
                // å¦‚æœå·²ç™»å½•ï¼Œå…ˆè·å–ç”¨æˆ·å·²æŠ¥åçš„æ´»åŠ¨
                if (currentUser) {
                    const regRes = await fetch(`${API_BASE}/registration/list?user_id=${currentUser.id}`);
                    const regData = await regRes.json();
                    userRegisteredEvents = regData.registrations.map(r => r.event_id);
                } else {
                    userRegisteredEvents = [];
                }

                const res = await fetch(`${API_BASE}/event/list`);
                const data = await res.json();
                const elapsed = Date.now() - start;
                
                document.getElementById('totalEvents').textContent = data.events.length;
                document.getElementById('cacheHit').textContent = data.from_cache ? 'æ˜¯' : 'å¦';
                document.getElementById('responseTime').textContent = elapsed;
                
                const html = data.events.map(e => {
                    const isRegistered = userRegisteredEvents.includes(e.id);
                    const isFull = e.current_participants >= e.max_participants;
                    
                    let statusClass, statusText, btnText, btnDisabled, btnClass;
                    if (isRegistered) {
                        statusClass = 'status-registered';
                        statusText = 'å·²æŠ¥å';
                        btnText = 'å·²æŠ¥å';
                        btnDisabled = 'disabled';
                        btnClass = 'btn-registered';
                    } else if (isFull) {
                        statusClass = 'status-full';
                        statusText = 'å·²æ»¡';
                        btnText = 'åé¢å·²æ»¡';
                        btnDisabled = 'disabled';
                        btnClass = 'btn-primary';
                    } else {
                        statusClass = 'status-open';
                        statusText = 'å¯æŠ¥å';
                        btnText = 'ç«‹å³æŠ¥å';
                        btnDisabled = '';
                        btnClass = 'btn-primary';
                    }
                    
                    return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3>${e.title}</h3>
                                <p>${e.description || 'æš‚æ— æè¿°'}</p>
                                <div class="meta">
                                    <span>ğŸ“ ${e.location || 'å¾…å®š'}</span>
                                    <span>ğŸ“… ${e.start_time}</span>
                                    <span>ğŸ‘¥ ${e.current_participants}/${e.max_participants}</span>
                                </div>
                            </div>
                            <div>
                                <span class="status ${statusClass}">${statusText}</span>
                                <br><br>
                                <button class="btn ${btnClass}" onclick="openRegister(${e.id}, '${e.title}')" ${btnDisabled}>
                                    ${btnText}
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
                document.getElementById('eventList').innerHTML = html;
            } catch (err) {
                document.getElementById('eventList').innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨</div>';
            }
        }

        // åˆ‡æ¢åˆ°æ³¨å†Œ
        function switchToRegister() {
            hideModal('loginModal');
            showModal('registerUserModal');
        }

        // åˆ‡æ¢åˆ°ç™»å½•
        function switchToLogin() {
            hideModal('registerUserModal');
            showModal('loginModal');
        }

        // ç”¨æˆ·æ³¨å†Œ
        async function registerUser() {
            const studentId = document.getElementById('regStudentId').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const collegeId = document.getElementById('regCollege').value;
            
            if (!studentId || !username || !password) {
                document.getElementById('registerUserAlert').innerHTML = '<div class="alert alert-error">è¯·å¡«å†™å®Œæ•´ä¿¡æ¯</div>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/user/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        student_id: studentId, 
                        username: username,
                        password: password,
                        college_id: parseInt(collegeId)
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('registerUserAlert').innerHTML = '<div class="alert alert-success">æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•</div>';
                    setTimeout(() => {
                        switchToLogin();
                        document.getElementById('loginStudentId').value = studentId;
                        document.getElementById('loginPassword').value = password;
                    }, 1500);
                } else {
                    document.getElementById('registerUserAlert').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                }
            } catch (err) {
                document.getElementById('registerUserAlert').innerHTML = '<div class="alert alert-error">æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // ç™»å½•
        async function login() {
            const studentId = document.getElementById('loginStudentId').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    currentUser = { ...data.user, session_id: data.session_id };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserUI();
                    hideModal('loginModal');
                    loadEvents();  // ç™»å½•ååˆ·æ–°æ´»åŠ¨åˆ—è¡¨ï¼Œæ˜¾ç¤ºå·²æŠ¥åçŠ¶æ€
                } else {
                    document.getElementById('loginAlert').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                }
            } catch (err) {
                document.getElementById('loginAlert').innerHTML = '<div class="alert alert-error">ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            updateUserUI();
            loadEvents();  // é€€å‡ºååˆ·æ–°æ´»åŠ¨åˆ—è¡¨
        }

        // æ›´æ–°ç”¨æˆ·UI
        function updateUserUI() {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            if (currentUser) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                document.getElementById('userAvatar').textContent = currentUser.username[0];
                document.getElementById('userName').textContent = currentUser.username;
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
            }
        }

        // æ‰“å¼€æŠ¥åå¼¹çª—
        function openRegister(eventId, title) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                showModal('loginModal');
                return;
            }
            currentEventId = eventId;
            document.getElementById('registerEventTitle').textContent = `æ´»åŠ¨ï¼š${title}`;
            document.getElementById('registerAlert').innerHTML = '';
            document.getElementById('captchaInput').value = '';
            refreshCaptcha();
            showModal('registerModal');
        }

        // åˆ·æ–°éªŒè¯ç 
        async function refreshCaptcha() {
            captchaSession = Date.now().toString();
            try {
                const res = await fetch(`${API_BASE}/captcha/generate?session_id=${captchaSession}`);
                const data = await res.json();
                document.getElementById('captchaCode').textContent = data.captcha;
            } catch (err) {
                document.getElementById('captchaCode').textContent = 'ERROR';
            }
        }

        // æäº¤æŠ¥å
        async function submitRegistration() {
            const captcha = document.getElementById('captchaInput').value;
            if (!captcha) {
                document.getElementById('registerAlert').innerHTML = '<div class="alert alert-error">è¯·è¾“å…¥éªŒè¯ç </div>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/registration/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        event_id: currentEventId,
                        captcha: captcha,
                        captcha_session: captchaSession
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('registerAlert').innerHTML = '<div class="alert alert-success">æŠ¥åæˆåŠŸï¼</div>';
                    setTimeout(() => {
                        hideModal('registerModal');
                        loadEvents();
                    }, 1500);
                } else {
                    document.getElementById('registerAlert').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                    refreshCaptcha();
                }
            } catch (err) {
                document.getElementById('registerAlert').innerHTML = '<div class="alert alert-error">æŠ¥åå¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // åŠ è½½æˆ‘çš„æŠ¥å
        async function loadMyRegistrations() {
            if (!currentUser) {
                document.getElementById('registrationList').innerHTML = '<p style="color: #888;">è¯·å…ˆç™»å½•</p>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/registration/list?user_id=${currentUser.id}`);
                const data = await res.json();
                
                if (data.registrations.length === 0) {
                    document.getElementById('registrationList').innerHTML = '<p style="color: #888;">æš‚æ— æŠ¥åè®°å½•</p>';
                    return;
                }
                
                const html = data.registrations.map(r => `
                    <div style="padding: 15px 0; border-bottom: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${r.title}</strong>
                                <div style="color: #888; font-size: 13px; margin-top: 5px;">
                                    ğŸ“… ${r.start_time} | ğŸ“ ${r.location || 'å¾…å®š'}
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="cancelRegistration(${r.event_id})">å–æ¶ˆæŠ¥å</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('registrationList').innerHTML = html;
            } catch (err) {
                document.getElementById('registrationList').innerHTML = '<p style="color: #e74c3c;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // å–æ¶ˆæŠ¥å
        async function cancelRegistration(eventId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæŠ¥åå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/registration/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id, event_id: eventId })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('å–æ¶ˆæˆåŠŸ');
                    loadMyRegistrations();
                    loadEvents();
                }
            } catch (err) {
                alert('å–æ¶ˆå¤±è´¥');
            }
        }
    </script>
</body>
</html>
